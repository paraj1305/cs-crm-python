<!DOCTYPE html>
{% extends 'superadmin/base.html' %}
{% load custom_filters %}
{% block content %}
{% if messages %}
<div id="message-container">
    {% for message in messages %}
    <div class="alert alert-warning">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
<div class="container mt-5">
    <div class="card">
        <div class="card-header">
            <h5>Invoice Details</h5>
            {% if message %}
            <div class="alert alert-info">
                {{ message }}
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            <p>
                {% if invoice.payment_status == 'paid' %}
                    <span class="badge badge-success">{{ invoice.payment_status }}</span>
                {% else %}
                    <span class="badge badge-danger">{{ invoice.payment_status }}</span>
                {% endif %}
            </p>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Invoice ID:</strong> {{ invoice.id }}</p>
                    <p><strong>Client:</strong> {{ invoice.client.name }}</p>
                    <p><strong>Address:</strong> {{ invoice.client.address }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Company:</strong> {{ invoice.client.company }}</p>
                    <p><strong>Invoice Date:</strong> {{ invoice.invoice_date|date:"d/m/Y" }}</p>
                    <p><strong>Sent to Client:</strong> {% if invoice.sent_to_client %}Yes{% else %}No{% endif %}</p>
                </div>
            </div>

            <h3 class="mt-4">Invoice Items</h3>
            {% if invoice.items.all %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items.all %}
                    <tr>
                        <td>{{ item.title }}</td>
                        <td>${{ item.rate }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="mt-3">
                <p><strong>Total Rate:</strong> ${{ total_rate }}</p>
                <p><strong>Tax Percentage:</strong> {{ tax_percentage }}%</p> <!-- Display tax percentage -->
                <p><strong>Tax Amount:</strong> ${{ tax_amount }}</p>
                <p><strong>Adjusted Total:</strong> ${{ adjusted_total }}</p>
            </div>
            {% else %}
            <div class="alert alert-warning" role="alert">
                No items found for this invoice.
            </div>
            {% endif %}

            <div class="mt-3">
                <form action="{% url 'superadmin:invoice_delete' invoice.id %}" method="post" class="d-inline mr-2">
                    {% csrf_token %}
                    <input type="submit" value="Delete Invoice" class="btn btn-danger" onclick="return confirmDelete()">
                </form>
                <form action="{% url 'superadmin:send_invoice_pdf' invoice.id %}" method="post" class="d-inline mr-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Send to Client</button>
                </form>
                <form action="{% url 'superadmin:download_invoice_pdf' invoice.id %}" method="get" class="d-inline">
                    <button type="submit" class="btn btn-info">Download Invoice</button>
                </form>
            </div>
            
        </div>
        <div class="mx-4 mt-4">
            <h5>Other Invoices for {{ invoice.client }}</h5>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Invoice ID</th>
                        <th>Invoice Date</th>
                        <th>Total Amount</th>
                        <th>Payment Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client_invoice in client_invoices %}
                        <tr>
                            <td>{{ client_invoice.id }}</td>
                            <td>{{ client_invoice.invoice_date|date:"d/m/Y" }}</td>
                            <td>{{ client_invoice.total_amount }}</td>
                            <td>
                                {% if invoice.payment_status == 'paid' %}
                                <span class="badge badge-success">{{ invoice.payment_status }}</span>
                                {% else %}
                                <span class="badge badge-danger">{{ invoice.payment_status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'superadmin:invoice_detail' client_invoice.id %}" class="btn btn-primary btn-sm">View</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No other invoices available for this client.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function confirmDelete() {
        return confirm('Are you sure you want to delete this invoice?');
    }
</script>
{% endblock %}
