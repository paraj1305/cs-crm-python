<!DOCTYPE html>
{% extends 'superadmin/base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title text-center">{{ form.instance.pk|yesno:"Update Client,Create Client" }}</h3>
                </div>
                {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-warning">{{ message }}</div>
                {% endfor %}
                {% endif %}
                <form id="client-form" method="post" enctype="multipart/form-data" action="{% if form.instance.pk %}{% url 'superadmin:client_update' form.instance.pk %}{% else %}{% url 'superadmin:client_create' %}{% endif %}">
                    {% csrf_token %}
                    <div class="card-body p-3">
                        {{ form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.name.id_for_label }}">Name</label>
                                    {{ form.name|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-name"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.email.id_for_label }}">Email</label>
                                    {{ form.email|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-email"></div>
                                </div>
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.phone.id_for_label }}">Phone</label>
                                    {{ form.phone|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-phone"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.website.id_for_label }}">Website</label>
                                    {{ form.website|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-website"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.company.id_for_label }}">Company</label>
                                    {{ form.company|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-company"></div>
                                </div>
                            </div>
                           
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.location.id_for_label }}">Location</label>
                                    {{ form.location|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-location"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.industry.id_for_label }}">Industry</label>
                                    {{ form.industry|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-industry"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.since.id_for_label }}">Since</label>
                                    {{ form.since|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-since"></div>
                                </div>
                            </div>

                           
                        </div>
                    
                        <div class="form-group">
                            <label for="{{ form.address.id_for_label }}">Address</label>
                            {{ form.address|add_class:"form-control form-control-sm" }}
                            <div class="text-danger small" id="error-address"></div>
                        </div>
                        <div class="form-group">
                            <label for="dropzone">Files</label>
                            <div id="dropzone" class="dropzone"></div>
                            <div class="text-danger small" id="error-dropzone"></div>
                        </div>
                    </div>
                    <div class="card-footer text-right">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    Dropzone.autoDiscover = false;

    var dropzone = new Dropzone("#dropzone", {
        url: "{% url 'superadmin:upload_client_images' %}",
        paramName: "file",
        maxFilesize: false,
        addRemoveLinks: true,
        dictDefaultMessage: "Drag files here or click to upload",
        autoProcessQueue: false,
        parallelUploads: 10,
        headers: {
            "X-CSRFToken": getCSRFToken()
        },
        init: function() {
            var myDropzone = this;

            document.querySelector("#submit-button").addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear previous errors
                document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

                var clientForm = document.querySelector("#client-form");
                var formData = new FormData(clientForm);

                fetch(clientForm.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": getCSRFToken()
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.client_id) {
                        if (myDropzone.getQueuedFiles().length > 0) {
                            myDropzone.options.params = { client_id: data.client_id };
                            myDropzone.processQueue();
                        } else {
                            window.location.href = "{% url 'superadmin:client_list' %}";
                        }
                    } else if (data.errors) {
                        for (let [field, messages] of Object.entries(data.errors)) {
                            let errorElement = document.getElementById(`error-${field}`);
                            if (errorElement) {
                                errorElement.textContent = messages.join(', ');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
            });

            myDropzone.on("queuecomplete", function() {
                window.location.href = "{% url 'superadmin:client_list' %}";
            });

            myDropzone.on("error", function(file, response) {
                let dropzoneErrorElement = document.getElementById('error-dropzone');
                if (dropzoneErrorElement) {
                    dropzoneErrorElement.textContent = response;
                }
                console.error("Error uploading file:", response);
            });
        }
    });
</script>
{% endblock %}
