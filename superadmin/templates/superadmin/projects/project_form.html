<!DOCTYPE html>
{% extends 'superadmin/base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title text-center">{{ form.instance.pk|yesno:"Update Project,Create Project" }}</h3>
                </div>
                {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-warning">{{ message }}</div>
                {% endfor %}
                {% endif %}
                <form id="project-form" method="post" enctype="multipart/form-data" action="{% if form.instance.pk %}{% url 'superadmin:project_update' form.instance.pk %}{% else %}{% url 'superadmin:project_create' %}{% endif %}">
                    {% csrf_token %}
                    <div class="card-body p-3">
                        {{ form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.project_title.id_for_label }}">Project Title</label>
                                    {{ form.project_title|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-project_title"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.start_date.id_for_label }}">Start Date</label>
                                    {{ form.start_date|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-start_date"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.deadline.id_for_label }}">Deadline</label>
                                    {{ form.deadline|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-deadline"></div>
                                </div>
                            </div>


                            
                        </div>
                       
                      
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.project_cost.id_for_label }}">Project Cost ($)</label>
                                    {{ form.project_cost|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-project_cost"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}">Status</label>
                                    {{ form.status|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-status"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.priority.id_for_label }}">Priority</label>
                                    {{ form.priority|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-priority"></div>
                                </div>
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.client.id_for_label }}">Client</label>
                                    {{ form.client|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-client"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.employees.id_for_label }}">Employees</label>
                                    {{ form.employees|add_class:"form-control form-control-sm js-example-basic-multiple border-primary" }}
                                    <div class="text-danger small" id="error-employees"></div>
                                </div>
                            </div>
                            
                        </div>
                        <div class="form-group">
                            <label for="dropzone">Files</label>
                            <div id="dropzone" class="dropzone"></div>
                            <div class="text-danger small" id="error-dropzone"></div>
                        </div>
                    </div>
                    <div class="card-footer text-right">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// multiple selection
$(document).ready(function() {
    $('.js-example-basic-multiple').select2({
        placeholder: "Select employees",
        allowClear: true,
        width: '100%'
    });

    // Display the selected file name in the label
    $(".custom-file-input").on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });
});


    // Get the CSRF token from the form's hidden input
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Ensure Dropzone is not automatically discovering and processing elements
    Dropzone.autoDiscover = false;

    var dropzone = new Dropzone("#dropzone", {
        url: "{% url 'superadmin:upload_project_filess' %}", // URL for uploading images
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: false , // MB
        addRemoveLinks: true,
        dictDefaultMessage: "Drag files here or click to upload",
        autoProcessQueue: false, // Prevent auto-processing; we'll manually process the queue
        parallelUploads: 10, // Number of files to process simultaneously
        headers: {
            "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
        },
        init: function() {
            var myDropzone = this;

            // Handle form submission
            document.querySelector("#submit-button").addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear previous errors
                document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

                var projectForm = document.querySelector("#project-form");
                var formData = new FormData(projectForm);

                // Submit the form via AJAX
                fetch(projectForm.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.project_id) {
                        if (myDropzone.getQueuedFiles().length > 0) {
                            myDropzone.options.params = { project_id: data.project_id };
                            myDropzone.processQueue();
                        } else {
                            window.location.href = "{% url 'superadmin:project_list' %}";
                        }
                    } else if (data.errors) {
                        for (let [field, messages] of Object.entries(data.errors)) {
                            let errorElement = document.getElementById(`error-${field}`);
                            if (errorElement) {
                                errorElement.textContent = messages.join(', ');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
            });

            // Handle successful uploads
            myDropzone.on("queuecomplete", function() {
                // Redirect to the project list or show a success message
                window.location.href = "{% url 'superadmin:project_list' %}";
            });

            // Handle errors during file upload
            myDropzone.on("error", function(file, response) {
                let dropzoneErrorElement = document.getElementById('error-dropzone');
                if (dropzoneErrorElement) {
                    dropzoneErrorElement.textContent = response;
                }
                console.error("Error uploading file:", response);
            });
        }
    });
</script>
{% endblock extra_scripts %}
